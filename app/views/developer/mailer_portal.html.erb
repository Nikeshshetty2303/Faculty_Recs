<%= render partial: 'partials/navbar', locals: { user: @user, locale: true } %>
<%= stylesheet_link_tag 'allresponses' %>

<div class="container mt-3">
  <div class="row">
    <div class="col-md-12">
      <!-- Display flash messages -->
      <% flash.each do |type, message| %>
        <div class="alert alert-<%= type == 'error' ? 'danger' : type %> alert-dismissible fade show" role="alert">
          <%= message %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>

      <ul class="nav nav-tabs">
        <li class="nav-item">
          <%= link_to 'Multi Application User', developer_multiple_app_user_path(userid: @user.id), class: "nav-link" %>
        </li>
        <li class="nav-item">
          <%= link_to 'CSV Generator', developer_csv_generator_path(userid: @user.id), class: "nav-link" %>
        </li>
         <li class="nav-item">
          <%= link_to 'Credit Question Check', developer_credit_questions_check_path(userid: @user.id), class: "nav-link" %>
        </li>
        <li class="nav-item">
          <%= link_to 'Mailer Portal', developer_mailer_portal_path(userid: @user.id), class: "nav-link active" %>
        </li>
        <li class="nav-item">
          <%= link_to 'Shortlist Mailer Status', developer_shortlist_mailer_status_path(userid: @user.id), class: "nav-link" %>
        </li>
      </ul>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Application Shortlist Mailer</h5>
          <p class="card-text">Send emails to shortlisted applicants.</p>
          <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#shortlistModal">
            Open Shortlist Mailer
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Referee Mailer</h5>
          <p class="card-text">Send emails to referees for applicants.</p>
          <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#refereeModal">
            Open Referee Mailer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Shortlist Mailer Modal -->
<div class="modal fade" id="shortlistModal" tabindex="-1" aria-labelledby="shortlistModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shortlistModalLabel">Application Shortlist Mailer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with(url: developer_application_shortlist_mailer_path, method: :post, local: true, class: "mailer-form", id: "shortlistForm") do |form| %>
          <div class="mb-3">
            <%= form.label :app_nos, "Application Numbers (comma-separated)", class: "form-label" %>
            <%= form.text_area :app_nos, class: "form-control", required: true, rows: 3 %>
          </div>
          <div class="mb-3">
            <%= form.label :email, "Testing Email", class: "form-label" %>
            <%= form.email_field :email, class: "form-control", rows: 3 %>
          </div>
          <div class="text-center">
            <%= form.submit "Send Mail", class: "btn btn-primary", data: { action: "click->mailer#confirmShortlist" } %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Referee Mailer Modal -->
<div class="modal fade" id="refereeModal" tabindex="-1" aria-labelledby="refereeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="refereeModalLabel">Referee Mailer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with(url: developer_application_referee_mailer_path, method: :post, local: true, class: "mailer-form", id: "refereeForm") do |form| %>
          <div class="mb-3">
            <%= form.label :app_nos, "Application Numbers (comma-separated)", class: "form-label" %>
            <%= form.text_area :app_nos, class: "form-control", required: true, rows: 3 %>
          </div>
          <div class="text-center">
            <%= form.submit "Send Mail", class: "btn btn-primary", data: { action: "click->mailer#confirmReferee" } %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirm Mailer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to send emails to the following application numbers?</p>
        <p id="confirmAppNos"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmSendBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<style>
  .card {
    transition: transform 0.3s;
  }
  .card:hover {
    transform: scale(1.05);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const shortlistForm = document.getElementById('shortlistForm');
    const refereeForm = document.getElementById('refereeForm');
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmSendBtn = document.getElementById('confirmSendBtn');
    const confirmAppNos = document.getElementById('confirmAppNos');

    let currentForm = null;

    function showConfirmationModal(form) {
      currentForm = form;
      const appNos = form.elements.app_nos.value;
      confirmAppNos.textContent = appNos;
      confirmationModal.show();
    }

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="click->mailer#confirmShortlist"]')) {
        e.preventDefault();
        showConfirmationModal(shortlistForm);
      } else if (e.target.matches('[data-action="click->mailer#confirmReferee"]')) {
        e.preventDefault();
        showConfirmationModal(refereeForm);
      }
    });

    confirmSendBtn.addEventListener('click', function() {
      if (currentForm) {
        currentForm.submit();
        confirmationModal.hide();
      }
    });

    // Auto-dismiss alerts after 5 seconds
    setTimeout(function() {
      const alerts = document.querySelectorAll('.alert');
      alerts.forEach(function(alert) {
        bootstrap.Alert.getOrCreateInstance(alert).close();
      });
    }, 5000);
  });
</script>