<%= render partial: 'partials/navbar', locals: { user: @user, locale: true } %>
<%= stylesheet_link_tag 'myresponses' %>

<div class="container mt-4">
  <div class="text-center">
    <h1 class="fw-bold mb-2">Your Responses</h1>
    <p class="text-muted">
      <i class="fas fa-info-circle me-2"></i>
      Please review all responses and uploads carefully before freezing your application.
    </p>
  </div>
  <%= link_to "Go Back", :back, class: "btn btn-light mb-4" %>

  <div class="responses">
    <% @responses.where(profile_response: nil).each do |response| %>
      <div class="card mb-4">
        <div class="card-body">
          <% present_response_id = response.id %>
          <% below_responses = Response.where(profile_response: true).where("id < ?", present_response_id) %>
          <% count_below_responses = below_responses.count %>
          <% role = response.form.role %>
          <% dept = response.form.department.title %>

          <%if response.app_no.present?%>
            <h5 class="card-title"><%=response.app_no%></h5>
          <%else%>
            <h5 class="card-title"><%= "#{role}#{dept}#{1000 + response.id - count_below_responses}" %></h5>
          <%end%>


         <% if response.status == "Free" && response.skipped.present? && response.skipped != "[]" %>
            <% skipped_items = JSON.parse(response.skipped) rescue [] %>
            <% if skipped_items.any? %>
              <div class="alert alert-danger mt-3" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Warning:</strong> Update PDF(s) uploaded in the following question(s):
                <ul class="mt-2 mb-0">
                  <% skipped_items.each do |item| %>
                    <li><%= item %></li>
                  <% end %>
                </ul>
                <small class="d-block mt-2">These PDFs cannot be combined because these might not have been scanned properly and might be corrupted or password-secured.</small>
              </div>
            <% end %>
          <% end %>


    <div class="d-flex justify-content-between align-items-center mt-3">
      <p class="mb-0">
        <strong>Credits Obtained:</strong> <%= response.credit_score %>
      </p>

          <% if response.status == "Freezed"%>

              <small class="text-success">
                <i class="fas fa-exclamation-triangle me-1"></i>
                  The application has been submitted successfully!
              </small>
          <% end %>
      </div>

          <div class="btn-group btn-group-responsive" role="group" aria-label="Response actions">
            <%if response.status == "Freezed"%>
              <%= link_to "View Credit Response", my_credit_freezed_response_path(id: response.id, userid: @user.id), class: 'btn btn-outline-primary btn-sm' %>
              <%= link_to "Print Finalized Application", view_app_pdf_response_path(id: response.id, userid: @user.id), class: 'btn btn-outline-success btn-sm' %>
              <%= link_to "View Finalized Uploads", view_combined_pdf_response_path(id: response.id, userid: response.user.id), class: 'btn btn-outline-info btn-sm', target: "_blank" %>
               <!-- <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#unfreezeModal<%= response.id %>">
                Freezed
              </button> -->
              <button type="button" class="btn btn-outline-dark btn-sm" disabled>
                Freezed
              </button>

            <%elsif response.status == "Free"%>
              <%= link_to "Credit Response", my_credit_response_path(id: response.id, userid: @user.id), class: 'btn btn-outline-primary btn-sm' %>
              <%= link_to "Form Response", display_response_path(id: response.id, userid: @user.id), class: 'btn btn-outline-secondary btn-sm' %>
              <%= link_to "Print Response", print_response_path(id: response.id, userid: @user.id, format: :pdf), class: 'btn btn-outline-success btn-sm' %>
              <%= link_to "View Uploads", combine_pdf_response_path(id: response.id, userid: @user.id), class: 'btn btn-outline-info btn-sm' %>
              <% if response.app_no.present? && response.combined_pdf.present? && response.user.tab_no > Tab.count%>
              <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#freezeModal<%= response.id %>">
                Freeze
              </button>
              <%else%>
                <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#freezeModal<%= response.id %>" disabled>
                Freeze
                </button>
              <%end%>

            <% end %>
          </div>

          <%if response.user.tab_no <= Tab.count%>
               <small class="text-dark mt-2 d-block">
              Please complete the appplication profile (Referee tab has been added)
              </small>
          <% elsif !response.app_no.present? %>
            <small class="text-dark mt-2 d-block">
              Complete the post-specific form (by clicking on form response) to enable the freeze option.
            </small>
          <% elsif !response.combined_pdf.present?%>
            <small class="text-dark mt-2 d-block">
              You haven't reviewed and verified your application profile uploads, click on view uploads to do so and enable freeze option.
            </small>
            <%end%>
        </div>
      </div>

      <!-- Freeze Modal -->
      <div class="modal fade" id="freezeModal<%= response.id %>" tabindex="-1" aria-labelledby="freezeModalLabel<%= response.id %>" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="freezeModalLabel<%= response.id %>">Confirm Freeze</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you certain that you want to finalize and freeze this application?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <%= link_to "Freeze", update_status_response_path(id: response.id, userid: @user.id), class: 'btn btn-warning' %>
            </div>
          </div>
        </div>
      </div>

      <!-- Unfreeze Modal -->
      <div class="modal fade" id="unfreezeModal<%= response.id %>" tabindex="-1" aria-labelledby="unfreezeModalLabel<%= response.id %>" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="unfreezeModalLabel<%= response.id %>">Confirm Unfreeze</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to unfreeze this application?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <%= link_to "Unfreeze", update_status_response_path(id: response.id, userid: @user.id), class: 'btn btn-dark' %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
</script>
