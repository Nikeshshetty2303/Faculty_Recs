<!-- HTML (ERB) -->
<%= render partial: 'partials/navbar', locals: { user: @user, locale: true } %>
<%= stylesheet_link_tag 'allresponses' %>

<div class="container mt-3">
  <div class="row">
    <div class="col-md-12">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <%= link_to 'Users', admin_dashboard_all_users_path(userid: @user.id), class: "nav-link" %>
        </li>
        <li class="nav-item">
          <%= link_to 'Responses', admin_dashboard_all_responses_path(userid: @user.id), class: "nav-link" %>
        </li>
        <li class="nav-item">
          <%= link_to 'Statistics', admin_dashboard_statistics_path(userid: @user.id), class: "nav-link" %>
        </li>
         <li class="nav-item">
          <%= link_to 'Application Extracts', admin_dashboard_extract_portal_path(userid: @user.id), class: "nav-link active" %>
        </li>
        <li class="nav-item">
          <%= link_to 'Applications Table', admin_dashboard_application_summary_table_path(userid: @user.id), class: "nav-link" %>
        </li>
      </ul>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-md-6 offset-md-3">
      <div class="search-container">
        <input type="text" class="form-control" id="searchBar" placeholder="Search for departments...">
        <i class="fas fa-search"></i>
      </div>
    </div>
  </div>
  <div class="row" id="departmentCards">
    <% Department.all.each do |department| %>
      <div class="col-md-4 mb-4">
        <div class="card h-100 department-card" data-bs-toggle="modal" data-bs-target="#modal<%= department.id %>">
          <div class="card-body">
            <h5 class="card-title"><%= department.title %></h5>
            <p class="card-text">Click to view extracts</p>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<% Department.all.each do |department| %>
  <div class="modal fade" id="modal<%= department.id %>" tabindex="-1" aria-labelledby="modalLabel<%= department.id %>" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5
          class="modal-title" id="modalLabel<%= department.id %>"><%= department.title %> Extracts</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="btn-group w-100 mb-3" role="group" aria-label="Format selection">
            <button type="button" class="btn btn-outline-primary active" data-format="pdf">PDF</button>
            <button type="button" class="btn btn-outline-primary" data-format="excel">Excel</button>
          </div>
          <div id="pdfLinks<%= department.id %>" class="format-links">
            <% Form.where(department_id: department.id).each do |form| %>
              <div class="d-grid gap-2 mb-2">
                <%= link_to "#{form.role} Report.pdf", admin_dashboard_view_summary_report_path(form_id: form.id, format: :pdf), class: 'btn btn-outline-primary', target: '_blank' %>
              </div>
            <% end %>
          </div>
          <div id="excelLinks<%= department.id %>" class="format-links" style="display: none;">
            <% Form.where(department_id: department.id).each do |form| %>
              <div class="d-grid gap-2 mb-2">
                <%= link_to "#{form.role} Report.xlsx", admin_dashboard_view_summary_report_csv_path(form_id: form.id, format: :xlsx), class: 'btn btn-outline-primary', target: '_blank' %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    let searchBar = document.getElementById('searchBar');
    let departmentCards = document.querySelectorAll('.department-card');

    searchBar.addEventListener('input', function() {
      let searchTerm = this.value.toLowerCase();
      departmentCards.forEach(function(card) {
        let departmentName = card.querySelector('.card-title').textContent.toLowerCase();
        if (departmentName.includes(searchTerm)) {
          card.closest('.col-md-4').style.display = '';
        } else {
          card.closest('.col-md-4').style.display = 'none';
        }
      });
    });

    // Format selection functionality
    document.querySelectorAll('.modal').forEach(function(modal) {
      let pdfLinks = modal.querySelector('[id^="pdfLinks"]');
      let excelLinks = modal.querySelector('[id^="excelLinks"]');
      let formatButtons = modal.querySelectorAll('.btn-group [data-format]');

      formatButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          let format = this.getAttribute('data-format');
          formatButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');

          if (format === 'pdf') {
            pdfLinks.style.display = 'block';
            excelLinks.style.display = 'none';
          } else {
            pdfLinks.style.display = 'none';
            excelLinks.style.display = 'block';
          }
        });
      });
    });
  });
</script>