<%= render partial: 'partials/navbar', locals: { user: @user, locale: true } %>

<%
  app_group = Response.joins(form: :department)
                      .where(status: "Freezed")
                      .where(departments: { title: @user.validator })
                      .group_by(&:form)
                      .transform_values { |responses| responses.sort_by { |r| r.app_no.to_s.strip } }

  dept_total = app_group.values.sum(&:size)
%>

<style>
  .btn-group .btn.active {
    background-color: #007bffd1;
    color: #fff;
  }

  .nav-tabs .nav-link.active {
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
  }
</style>

<div class="container mt-3">
  <div class="row">
    <div class="col-md-12">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <%= link_to 'Users', admin_dashboard_all_users_path(userid: @user.id), class: "nav-link" %>
        </li>
        <li class="nav-item">
          <%= link_to 'Responses', admin_dashboard_all_responses_path(userid: @user.id), class: "nav-link" %>
        </li>
        <li class="nav-item">
          <%= link_to 'Statistics', admin_dashboard_statistics_path(userid: @user.id), class: "nav-link " %>
        </li>
        <li class="nav-item">
          <%= link_to 'Application Extracts', admin_dashboard_extract_portal_path(userid: @user.id), class: "nav-link " %>
        </li>
        <li class="nav-item">
          <%= link_to 'Applications Table', admin_dashboard_application_summary_table_path(userid: @user.id), class: "nav-link active" %>
        </li>
      </ul>
    </div>
  </div>
</div>

<div class="container mt-4">
  <%= link_to "Go Back", :back, class: "btn btn-light mb-3" %>
  <%= link_to "Download Credit Data", home_export_to_excel_path(format: :xlsx), class: "btn btn-outline-primary mb-3" %>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
      <h5 class="mb-0">Total Application in <%= @user.validator %> Department: <%= dept_total %></h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th scope="col">Category</th>
              <th scope="col">GEN</th>
              <th scope="col">SC</th>
              <th scope="col">ST</th>
              <th scope="col">OBC</th>
              <th scope="col">Not Entered</th>
              <th scope="col">Total</th>
            </tr>
          </thead>
          <tbody>
          <%
            total_gen = 0
            total_sc = 0
            total_st = 0
            total_obc = 0
            total_not_entered = 0
            total_all = 0
          %>
          <% app_group.each do |form, responses| %>
            <% categories = responses.each_with_object(Hash.new(0)) do |response, counts|
                 profile_response = response.user.responses.find_by(profile_response: true)
                 if profile_response
                   cat_answer = profile_response.answers.joins(:question).find_by(questions: { title: " Category" })
                   counts[cat_answer&.content] += 1 if cat_answer
                 end
               end %>
            <%
              gen = categories["GEN"]
              sc = categories["SC"]
              st = categories["ST"]
              obc = categories["OBC"]
              not_entered = responses.count - gen - sc - st - obc
              row_total = responses.count

              total_gen += gen
              total_sc += sc
              total_st += st
              total_obc += obc
              total_not_entered += not_entered
              total_all += row_total
            %>
            <tr>
              <td><%= form.role %></td>
              <td><%= gen %></td>
              <td><%= sc %></td>
              <td><%= st %></td>
              <td><%= obc %></td>
              <td><%= not_entered %></td>
              <td><%= row_total %></td>
            </tr>
          <% end %>
          <tr class="font-weight-bold">
            <td>Total</td>
            <td><%= total_gen %></td>
            <td><%= total_sc %></td>
            <td><%= total_st %></td>
            <td><%= total_obc %></td>
            <td><%= total_not_entered %></td>
            <td><%= total_all %></td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>